/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-28 上午10:16
 */
BizQQWPA.define('util.domain', function(){
    var domain = {},
        dm = document.domain;

    // in some cases, get location.href will throw security restriction error
    // so catch it and retry
    try{
        // in some cases, get location.href will throw security restriction error
        // so catch it and retry
        domain.url = location.href;
    } catch(e){
        domain.url = '';
    }

    domain.topDomain = function(){
            //in case of domains end up with .com.cn .edu.cn .gov.cn .org.cn
        var reg1 = /\.(?:(?:edu|gov|com|org|net)\.cn|co\.nz)$/,
            //in case of ip
            reg2 = /^[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d$/,
            // for domain ends like .com.cn, top domain starts from -3
            // for ip starts from 0
            // else slice from -2
            slicePos = reg1.test(dm) ? -3 : reg2.test(dm) ? 0 : -2;
        return dm.split('.').slice(slicePos).join('.');
    }();

    domain.domain = function(){
        var reg = /(?::[\/]{2}|:[\\]{3})([a-zA-Z0-9_\.]+)/;

        try{
            var ret = reg.exec(domain.url);
            return ret ? ret[1] || dm : dm;
        } catch(e){
            return dm;
        }
    }();

    return domain;
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-22 下午7:32
 */
BizQQWPA.define('wpa.wpaMgr', 'globalSettings,lang.each,util.proxy,util.cookie,util.titleFlash,util.report,util.serialize,util.domain,wpa.WPA', function(require){
    var globalSettings = require('globalSettings'),
        each = require('each'),
        proxy = require('proxy'),
        titleFlash = require('titleFlash'),
        report = require('report'),
        serialize = require('serialize'),
        domain = require('domain'),
        cookie = require('cookie'),
        WPA = require('WPA');

    var REPORT_POSSIBILITY = 40;

    var getTencentSig = function() {
            return (Math.round((Math.random()||0.5) * 2147483647) * (+new Date())) % 10000000000;
        },
        TENCENT_SIG_NAME = 'tencentSig',
        GAP = 1000 * 60 * 60 * 24 * 365 * 100;

    var passRandom = function(poss) {
        var r = poss || 10;//10% percent is the default value

        if (Math.random() * 100 <= r) {
            return true;
        }

        return false;
    };

    var reportWpa = function(url, opts) {

        if (passRandom(REPORT_POSSIBILITY)) {
            report(url + '?' + serialize(opts));
        }
    };

    var displayReport = function(params){
        var url = 'https://prom.b.qq.com/wpadisplay/r.gif?',
            optsArr = ['wty', 'type', 'nameAccount', 'kfuin', 'ws', 'aty', 'a', 'title', 'wording', 'wording2'],
            reportOpts = {
                version: globalSettings.version
            };

        each(optsArr, function(){
            reportOpts[this] = typeof params[this] === 'undefined' ? '' : params[this];
        });

        //经验值确保mqq的加载
        setTimeout(function() {
            try {
                //拿tencentSig
                var tencentSig = cookie.get(TENCENT_SIG_NAME);
                if (tencentSig) {
                    reportOpts[TENCENT_SIG_NAME] = tencentSig;
                } else {
                    var t = getTencentSig();
                    reportOpts[TENCENT_SIG_NAME] = t;
                    cookie.set(TENCENT_SIG_NAME, t, null, null, GAP);
                } 
                //拿设备标识
                var _mqq = window.mqq;
                if (_mqq) {
                     _mqq.device.getDeviceInfo(function(param) {
                        if (_mqq.core.android) {//是安卓系统
                            reportOpts.isAndroid = 1;
                            reportOpts.macAddr = param.macAddress;
                            reportOpts.imsi = param.imsi;
                        } else {//是iOS
                            reportOpts.isAndroid = 0;
                            reportOpts.idfa = param.idfa;
                        }
                        report(url + serialize(reportOpts));
                    });
                } else {
                    report(url + serialize(reportOpts));
                }
            } catch(e) {
                if (console && console.log) {
                    console.log(e);
                }
            }
        }, 1000);
        
    };

    return {
        newWPA: function(params){
            var nameAccount = params.nameAccount;
            if(!nameAccount){
                return;
            }

            displayReport(params);

            //添加展示上报
            //todo
            //组织上报的数据进行上报
            reportWpa('https://report.b.qq.com/crmReport/accesslog', {
                FUID: cookie.get('pgv_pvi'),
                FKFUin: params.kfuin,
                FNa: params.nameAccount,
                FRurl: window.document.referrer
            });

            return new WPA(params);
        },
        invite: function(params, di){
            var mgr = this,
                defaultInvite = function(){
                    //【您有新消息】 utf-8编码， 若不转码，在非utf-8页面会引起乱码
                    titleFlash.on('\u3010\u60A8\u6709\u65B0\u4FE1\u606F\u3011');

                    params.insert = function(node){
                        var body = document.getElementsByTagName('body')[0];
                        body.insertBefore(node, body.firstChild);
                    };
                    mgr.newWPA(params);
                };
            if(!di){
                defaultInvite();
                return;
            }

            try{
                var chat = proxy({params: params}, WPA.prototype.launchChat);
                window[di] && window[di](chat, params['msg']);
            }catch(e){
                // use event principle would be better
                defaultInvite()
            }
        }
    };
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-21
 * Time: 下午7:27
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('wpa.visitor', 'lang.browser,util.log,util.speedReport,util.getJSONP,util.domain,util.pubSub,wpa.filter,wpa.ta,wpa.invite,wpa.wpaMgr,wpa.ta,wpa.kfuin', function(require){
    var invite = require('invite'),
        domain = require('domain'),
        filter = require('filter'),
        getJSONP = require('getJSONP'),
        pubSub = require('pubSub'),
        log = require('log'),
        speedReport = require('speedReport'),
        ta = require('ta'),
        kfuinCahe = require('kfuin'),
        browser = require('browser');

    var CRM_BLOCK_ON_SERVERSIDE = 1;

    var GET_CONFIG_URL = 'https://visitor.crm2.qq.com/cgi/visitorcgi/ajax/wpa_first_heart_beat.php'; //cgi url for getting initiation config in load process

    return function(config){
        var nameAccount = config.nameAccount;

        if(!nameAccount || nameAccount === 'undefined'){
            return;
        }

        //if the nameAccount has been added in wpas, return;
        //check if the nameAccount is in TA's black list
        if(invite.isLoaded(nameAccount) || !filter.TA){
            return;
        }

        var uid, cfg,
            launch = function(uid, cfg){
                if(!uid || !cfg){
                    return;
                }

                if(cfg.block === CRM_BLOCK_ON_SERVERSIDE){
                    return;
                }

                /*根据ua来判断是否是网络爬虫，如果是则直接return*/
                if (browser && browser.ua) {
                    var spiderReg = /spider|bot|^\s*$/;
                    if (spiderReg.test(browser.ua)) {
                        return;
                    }
                }

                if(filter.CRM){
                    cfg.di = config.di;
                    cfg.kfuin = config.kfuin;
                    log(nameAccount + ' try launch slave');
                    invite.load(nameAccount, uid, cfg);
                }
            };

        pubSub.one('TA.loaded', function(data){
            uid = data;
            launch(uid, cfg);
        });

        pubSub.one('Invite.first', function(data){
            cfg = data;
            launch(uid, cfg);
        });

        //plugin TA
        ta(nameAccount, domain.topDomain, function(uid){
            pubSub.pub('TA.loaded', uid);
        });

        //get config && register site
        var opts = {
            nameAccount: nameAccount,
            dm: domain.topDomain,
            title: document.title,
            url: location.href.split('://')[1].split('?')[0] //no protocol
        };

        getJSONP(GET_CONFIG_URL, opts, function(cfg){
            pubSub.pub('Invite.first', cfg);
        });

        // set kfuin cache
        config.kfuin && kfuinCahe.set(nameAccount, config.kfuin);
    };
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-17
 * Time: 下午12:06
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('wpa.kfuin', 'util.getJSONP', function(require){
    var getJSONP = require('getJSONP');

    var GET_KFUIN_URL = 'https://wpl.b.qq.com/cgi/conv.php';

    var kfuins = {};

    return {
        get: function(nameAccount, callback){
            callback = callback || function(){};

            if(!nameAccount || kfuins[nameAccount]){
                callback(kfuins[nameAccount]);
                return;
            }

            var opts = {
                num: nameAccount
            };

            getJSONP(GET_KFUIN_URL, opts, function(rs){
                if(!rs || rs.r !== 0){
                    callback();
                    return;
                }

                var kfuin = kfuins[nameAccount] = rs.data.kfuin;
                callback(kfuin);
            });
        },

        set: function(nameAccount, kfuin){
            kfuins[nameAccount] = kfuin;
        }
    };
});/**
 * @fileOverview proxy module
 * @author amoschen
 * @version
 * Created: 12-8-2 下午9:59
 */
BizQQWPA.define('util.proxy', function(){
    return function(ns, fn){
        return function(){
            return fn.apply(ns, arguments);
        }
    }
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-27 下午9:13
 */
BizQQWPA.define('util.titleFlash', 'util.taskMgr', function(require){
    var TITLE_FLASH_GAP = 120;

    var taskMgr = require('taskMgr');

    var doc = document,
        title = doc.title,
        task = taskMgr.newTask(function(){
            var t = doc.title;
            doc.title = t.substr(1, t.length) + t.substr(0, 1);
        }, TITLE_FLASH_GAP);

    return titleFlash = {
        on: function(msg){
            //add msg before original title
            doc.title = msg + ('' + doc.title);
            task.run();
        },
        off: function(){
            task.pause();
            doc.title = title;
        }
    }
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-27 下午8:26
 */
BizQQWPA.define('util.cookie', function(){
    var doc = document;
    return {
        //domain,path & expires is optional
        //set false if no specified value
        set: function(name, value, domain, path, expires){
            if(expires){
                expires = new Date(+new Date() + expires);
            }

            var tempcookie = name + '=' + escape(value) +
                ((expires) ? '; expires=' + expires.toGMTString() : '') +
                ((path) ? '; path=' + path : '') +
                ((domain) ? '; domain=' + domain : '');

            //Ensure the cookie's size is under the limitation
            if(tempcookie.length < 4096) {
                doc.cookie = tempcookie
            }
        },

        get: function(name){
            var carr = doc.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
            if (carr != null){
                return unescape(carr[2]);
            }

            return null;
        },

        del: function(name, domain, path){
            if (this.get(name)){
                doc.cookie = name + '=' +
                    ((path) ? '; path=' + path : '') +
                    ((domain) ? '; domain=' + domain : '') +
                    ";expires=Thu, 01-Jan-1970 00:00:01 GMT";
            }
        },
        //find certain string in cookie with regexp
        find: function(pattern){
            return doc.cookie.match(pattern).split(',');
        }
    };
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-7
 * Time: 下午8:05
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('wpa.WPA', 'globalSettings,lang.browser,util.cookie,util.localStorage,lang.typeEnhance,util.serialize,util.proxy,util.pad,util.Bits,util.getScript,util.getJSONP,util.domain,util.events,util.onLoad,util.offset,util.report,util.log,util.speedReport,wpa.SelectPanel,util.onIframeLoaded,util.GUID,wpa.getQQVersion,wpa.ViewHelper,wpa.views,wpa.ta,wpa.kfuin,wpa.sid', function(require){
    var globalSettings = require('globalSettings'),
        proxy = require('proxy'),
        typeEnhance = require('typeEnhance'),
        pad = require('pad'),
        Bits = require('Bits'),
        getScript = require('getScript'),
        getJSONP = require('getJSONP'),
        domain = require('domain'),
        events = require('events'),
        onLoad = require('onLoad'),
        serialize = require('serialize'),
        browser = require('browser'),
        offset = require('offset'),
        report = require('report'),
        log = require('log'),
        speedReport = require('speedReport'),
        GUID = require('GUID'),
        SelectPanel = require('SelectPanel'),
        onIframeLoaded = require('onIframeLoaded'),
        getQQVersion = require('getQQVersion'),
        ViewHelper = require('ViewHelper'),
        views = require('views'),
        ta = require('ta'),
        kfuinCache = require('kfuin'),
        cookie = require('cookie'),
        localStorage = require('util.localStorage'),
        sidCache = require('sid');

    var global = window,
        //广告的监测代码是否加载了
        isDaAdded = 'isDaAdded',
        isFetchingDa = 'isFetchingDa',
        daList = [],
        TENCENT_SIG = 'tencentSig';

    //wpa params
    var WPA_TYPE_TA_INVITE_ONLY = '0', //no wpa will be created, TA & invite logic only
        WPA_TYPE_NORMAL = '1', //normal wpa, with TA & invite logic
        WPA_TYPE_LINK = '2', //for forumn & weibo, a link
        WPA_TYPE_CUSTOM = '3', //customized wpa
        SESSION_VERSION_TA = '4', //session version for wpa with TA, seperated from user customed wpa
        WPA_STYLE_TYPE_INVITE = '20', //invite wpa's style type
        APPOINTED_TYPE_AUTO = '0', //appointed type of automatic diversion
        APPOINTED_TYPE_KFEXT = '1', //appointed type of appointed kfext
        APPOINTED_TYPE_GROUP = '2', //appointed type of appointed group
        WPA_FLOAT_TYPE_FIXED = '0', //wpa style: float style fixed
        WPA_FLOAT_TYPE_SCROLL = '1', //wpa style: float style scroll
        WPA_FLOAT_POSITION_X_LEFT = '0', //wpa style: x-coordinate position, left
        WPA_FLOAT_POSITION_X_CENTER = '1', //wpa style: x-coordinate position, center
        WPA_FLOAT_POSITION_X_RIGHT = '2', //wpa style: x-coordinate position, right
        WPA_FLOAT_POSITION_Y_TOP = '0', //wpa style: y-coordinate position, top
        WPA_FLOAT_POSITION_Y_CENTER = '1', //wpa style: y-coordinate position, center
        WPA_FLOAT_POSITION_Y_BOTTOM = '2', //wpa style: y-coordinate position, bottom
        IS_INVITE_WPA_FALSE = '0', //param that seperate wpa conversations, false means normal wpa conversation
        IS_INVITE_WPA_TRUE = '1', //param that seperate wpa conversations, invite wpa conversation
		CHAT_TYPE_AIO = 1, // assign to launch qq chat
		CHAT_TYPE_ANONYMOUS = 2; //assign to launch anonymous chat

    var SPEED_REPORT_DISPLAY = 0.1,
        REPORT_POSSIBILITY = 40,
        visitorId;

    /************动态引入手Q的mqq库*******************/
    try {
        var mqqSrc = '//open.mobile.qq.com/sdk/qqapi.js?_bid=152',
            head = document.head || document.getElementsByTagName("head")[0] || document.documentElement,
            baseElement = head.getElementsByTagName("base")[0];

        if (!window.mqq && (browser.isIOS || browser.isAndroid)) {
            fetch(mqqSrc, '_mqq');
        }
    } catch (e) {
        if (console && console.log) {
            console.log(e);
        }
    }

    function fetch(uri, id, cb) {
        var node = document.createElement("script");

        node.charset = 'utf-8';
        node.async = true;
        node.src = uri;
        node.id = id || '';

        // For some cache cases in IE 6-8, the script executes IMMEDIATELY after
        // the end of the insert execution, so use `currentlyAddingScript` to
        // hold current node, for deriving uri in `define` call
        var currentlyAddingScript = node;
        
        node.onreadystatechange = node.onload = function() {
            if(/loaded|complete|undefined/.test(node.readyState) && typeof cb === 'function') {
                cb();
                node.onreadystatechange = node.onload = null;
            }
        };

        // ref: #185 & https://dev.jquery.com/ticket/2709
        baseElement ?
            head.insertBefore(node, baseElement) :
            head.appendChild(node);

        currentlyAddingScript = null;
    }


    /************************************/

    var passRandom = function(poss) {
        var r = poss || 10;//10% percent is the default value

        if (Math.random() * 100 <= r) {
            return true;
        }

        return false;
    };

    var randomId = function() {
        return (Math.round((Math.random()||0.5) * 2147483647) * (+new Date())) % 10000000000;
    };

    var reportWpa = function(url, opts) {

        if (passRandom(REPORT_POSSIBILITY)) {
            report(url + '?' + serialize(opts));
        }
    };

    var _log = function(msg) {
        if (console && console.log) {
            console.log(msg);
        }
    }

    var qidianDAReport = function() {
        try {
            var GLOBAL = window;
            // 这个是固定的，用于让用户自定义暴露接口的名字
            var HOOK_NAME = '__qq_qidian_da';
            // 对外接口的名字
            var EXPORT_NAME = GLOBAL[HOOK_NAME] || 'qidianDA';
            if (!EXPORT_NAME) {
                return;
            }
            var qidianDA = GLOBAL[EXPORT_NAME],
                nameAccount = daList.shift();
            if (!nameAccount) {
                return;
            }
            qidianDA('create', String(nameAccount), {
                'cid': String(visitorId),
                'src': 12,
                'pgv_pvi':  cookie.get('pgv_pvi') || '' 
            });
            qidianDA('set', 't1', new Date());
        } catch (e) {
            _log('[WPA][qidianDAReport]:error occured');
            _log(e);
        }
    };

    var addDaScript = function(nameAccount) {
        daList.push(nameAccount);
        if (!top[isFetchingDa]) {
            top[isFetchingDa] = true;
            fetch('//bqq.gtimg.com/da/i.js', '_da', function() {
                top[isDaAdded] = true;
                qidianDAReport();
            });
        } else {
            if (top[isDaAdded]) {
                qidianDAReport();
            }
        }
    };

    var WPA = function(params){
        this.params = params;
        this.insert = params.insert;
        this.wty = params.wty;

        var self = this,
            nameAccount = this.nameAccount = params.nameAccount,
            kfuin = this.kfuin = params.kfuin;

        //判断visitorId，即tencentSig在cookie中是否存在
        if (localStorage.getItem(TENCENT_SIG)) {
            visitorId = params.guid = localStorage.getItem(TENCENT_SIG);
        } else {
            var guid = randomId();
            visitorId = params.guid = guid;
            localStorage.setItem(TENCENT_SIG, guid);
        }

        //render wpa view
        switch (this.wty){
            case WPA_TYPE_NORMAL:
                this.render();
                break;
            case WPA_TYPE_CUSTOM:
                this.custom();
        }

        //preload kfuin & sid
        !this.kfuin && kfuinCache.get(nameAccount, function(data){
            data && (self.kfuin = data);
        });

        !this.sid && sidCache.get(nameAccount, function(data){
            data && (self.sid = data);
        });

        //添加广告的监控代码
        //added by vergil
        setTimeout(function() {
            addDaScript(nameAccount);
        }, 10);

		// report page source
        report('https://prom.b.qq.com/se/r.gif?na=' + nameAccount + '&ref=' + encodeURIComponent(document.referrer));
    };

    WPA.prototype = {
        render: function(){
            var params = this.params;

            //业务分发器，动态加载当前样式所需的业务js
            var width, height,
                type = parseInt(params['type']),
                typeStr,
                isFloat = false;

            //wpa style switch
            switch(type){
                // btn styles
                case 1: typeStr = 'a01'; width = 92; height = 22; break;
                case 2: typeStr = 'a02'; width = 77; height = 22; break;

                // float styles
                case 10: typeStr = 'b01'; width = 93; height = 151; isFloat = true; break;
                case 11: typeStr = 'b02'; width = 327; height = 172; isFloat = true; break;
                case 12: typeStr = 'b03'; width = 121; height = 277; isFloat = true; break;

                // invite styles
                case 20: typeStr = 'i01'; width = 327; height = 172; isFloat = true; break;

                // self-define styles
                case 30: typeStr = 'd01'; width = params['txw']; height = params['txh']; isFloat = true; break;
            }

            this.type = typeStr;
            this.width = width;
            this.height = height;
            this.createWPA();

            if( (type > 9 && type < 14) || type === 20 || type === 30 ){
                this.initFloatWPA();
            }
        },

        // create WPA node
        createWPA: function(){
            // speed report: start time stamp of view page
            var speedRpt = speedReport('7818', '21', '1');

            var wpa = this,
                type = this.type,
                width = this.width,
                height = this.height,
                view = views[type];

            // ie will reject operations when parent's domain is set
            var iframe;
            try{
                iframe = document.createElement('<iframe scrolling="no" frameborder="0" width="' + width + '" height="' + height + '" allowtransparency="true" src="about:blank"></iframe>');
            } catch(e) {
                iframe = document.createElement('iframe');
                iframe.width = width;
                iframe.height = height;
                iframe.setAttribute('scrolling', 'no');
                iframe.setAttribute('frameborder', 0);
                iframe.setAttribute('allowtransparency', true);
                iframe.setAttribute('src', 'about:blank');
            }

            this.node = iframe;
            this.insert(iframe);

            if(browser.msie){
                // when domain is set in parent page and blank iframe is not ready, access to it's content is denied in ie
                try{
                    var accessTest = iframe.contentWindow.document;
                } catch(e){
                    // Test result shows that access is denied
                    // So reset iframe's document.domain to be the same as parent page
                    iframe.src = 'javascript:void((function(){document.open();document.domain=\''+ document.domain + '\';document.close()})())';
                }
            }

            var loaded = function(){
                var iWin = iframe.contentWindow,
                    iDoc = iframe.contentDocument || iWin.document;

                iDoc.open();
                iDoc.write([
                    '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">',
                    '<html xmlns="https://www.w3.org/1999/xhtml">',
                    '<head>',
                        '<meta https-equiv="Content-Type" content="text/html; charset=utf-8" />',
                        browser.msie && iframe.src !== 'about:blank' ? '<script>document.domain=\'' + document.domain + '\';</script>' : '',
                    '</head>',
                    '<body>',
                        view.templ,
                    '</body>',
                    '</html>'
                ].join(''));
                iDoc.close();

                // add helper for views' initiation
                var helper = new ViewHelper(iDoc, wpa);

                view.init(iDoc, helper);

                //record time & report
                var point = 1;
                speedRpt.addPoint(point).send(SPEED_REPORT_DISPLAY);
            };

            onIframeLoaded(iframe, loaded);
        },

        /**
         * 浮动WPA的iframe加载器，判断目标页面加载成功后再show出来
         */
        initFloatWPA: function(){
            //创建浮动层
            var doc = window.document,
                params = this.params,
                type = parseInt(params['type']),
                node = this.node,
                width = this.width,
                height = this.height;

            node.style.cssText = [
                'display:none;',
                'position:absolute;',
                type === 20 ? 'z-index:2147483647!important;' : 'z-index:2147483646!important;'
            ].join(' ');

            //判断页面是否加载完毕
            onLoad(initIframeLoad);

            /**
             * 对B01、B02、B03、B04 node进行处理
             */
            function initIframeLoad(){
                var isty = node.style,
                    isIE = browser.msie,
                    ver = parseInt(browser.version, 10),
                    isQuirk = doc.compatMode === 'BackCompat';

                //非IE6统一使用position:fixed
                isty.position = parseInt(params['fsty'], 10) == 0 ? 'fixed' : 'absolute';

                //获取浮动的位置
                if(parseInt(params['fposX']) == 0){
                    isty.left = 8 + 'px';
                    isty.right = 'auto';
                    isty.marginLeft = 0;
                }else if(parseInt(params['fposX']) == 1){
                    isty.left = '50%';
                    isty.right = 'auto';
                    isty.marginLeft = '-'+parseInt(width/2) + 'px';
                }else{
                    isty.left = 'auto';
                    isty.right = 8 + 'px';
                    isty.marginLeft = 0;
                }
                if(parseInt(params['fposY']) == 0){
                    isty.top = 8 + 'px';
                    isty.bottom = 'auto';
                    isty.marginTop = 0;
                }else if(parseInt(params['fposY']) == 1){
                    isty.top = '50%';
                    isty.bottom = 'auto';
                    isty.marginTop = '-'+parseInt(height/2) + 'px';
                }else{
                    isty.top = 'auto';
                    isty.bottom = 8 + 'px';
                    isty.marginTop = 0;
                }

                //对IE6进行特殊处理position:absolute，用setInterval实现滚动跟随
                if((isIE & ver < 7) || isQuirk){
                    isty.position = 'absolute';
                    if(parseInt(params['fsty']) == 0){
                        //reset
                        isty.marginTop = 0;
                        var itop;

                        if(parseInt(params['fposY']) == 0){
                            itop = 8;
                        }else if(parseInt(params['fposY']) == 1){
                            itop = (offset.getClientHeight(doc) - height)/2;
                        }else{
                            itop = offset.getClientHeight(doc) - height - 8;
                        }

                        setInterval(function(){
                            isty.top = offset.getScrollTop(doc) + itop + 'px';
                        }, 128);
                    }
                }

                isty.display = 'block';
            }
        },

        custom: function(){
            events.addEvent(this.params.node, 'click', proxy(this, this.launchChat));
        },

        remove: function(){
            var node = this.node;
            node.parentNode.removeChild(node);
        },

        // Chat part
        /**
         * Launch a chat
         * @param {function} callback Callback when chat is launched
         */
        launchChat: function(callback){

			var wpa = this,
				sptReport = speedReport('7818', '21', '2'),
				chatType = this.params.chatType;

            //添加点击上报
            //todo
            //根据要求，只要点击了就上报
            reportWpa('https://report.b.qq.com/crmReport/clicklog', {
                FUID: cookie.get('pgv_pvi'),
                FKFUin: wpa.params.kfuin,
                FNa: wpa.params.nameAccount,
                FRurl: global.document.referrer
            });

            // Mobile
            if(browser.isIOS || browser.isAndroid){
                this.launchMobileChat();
                return;
            }
            
				
			if(chatType == CHAT_TYPE_ANONYMOUS){
				wpa.launchAnonymousChat(callback);
				return;
			}
			
			if(chatType == CHAT_TYPE_AIO){
				wpa.launchAIOChat(callback);
				return;
			}

            // since QQ browser plugin is not reliable
            // always try to launch AIO chat
            // no ie browser launch without checking QQ version
            !browser.msie && wpa.launchAIOChat(callback);

            getQQVersion(function(version){
                sptReport.addPoint(7).send();

                if(version){
                    // ie browser won't be launched unless QQ is install for sure
                    // otherwise page may be redirected to schema on error case when QQ not installed
                    browser.msie && wpa.launchAIOChat(callback);

                    return;
                }

                // show selections for user when no version detected ( not sure QQ exists or not)
                new SelectPanel({
                    //QQ已安装，点击会话
                    onAIOChat: function(){
                        wpa.launchAIOChat(callback);
                    },

                    //未安装，发起网页会话
                    onAnonyChat: function(){
                        wpa.launchAnonymousChat(callback);
                    }
                });
            });
        },

        launchMobileChat: function(){
            var nameAccount = this.params.nameAccount;

            // only kfuin are acceptable for scheme
            // use kfuin cache
            kfuinCache.get(nameAccount, function(kfuin){
                // for wechat
                // page outside qq.com should be redirect to proxy page at qq.com
                if(navigator.userAgent.indexOf('MicroMessenger') > -1 && domain.domain.indexOf('qq.com') === -1){
                    location.href = 'https://wpd.b.qq.com/page/info.php?nameAccount=' + nameAccount;
                    return;
                }

                // when running in standard browser
                // no QQ info known
                // try CRM schema
                // otherwise fallback to info page
                // @2014-08-04
                // fallback to QQ 4.5 schema is abandoned for it may cause double jumps
                launch(schema(), fallback);

                function schema(){
                    // mobile QQ has problem in resolving complex source url
                    // use domain temporarily
                    var dm = domain.domain,
                        type = 'crm';

                    // for older version of QQ
                    // when running inside QQ web view
                    // QQ version is determined                    
                    if(browser.isQQ && browser.QQVersion === '4.5'){
                        type = 'wpa';


                    }

                    //手q内部无法跳转bug
                    //2016-04-29
                    //added by vergil
                    //android和ios都一样用mqqwpa
                    if (browser.isQQ) {
                        return 'mqqwpa://im/chat?chat_type=' + type + '&uin=' + kfuin + '&version=1&src_type=web&web_src=' + location.protocol + '://' + dm;
                    }

                    return browser.isAndroid && browser.chrome && parseInt(browser.version, 10) > 25 ? 
                        'intent://im/chat?chat_type=' + type + '&uin=' + kfuin + '&version=1&src_type=web&web_src=' + location.protocol + '://' + dm + '#Intent;scheme=mqqwpa;action=android.intent.action.VIEW;end' :
                        'mqqwpa://im/chat?chat_type=' + type + '&uin=' + kfuin + '&version=1&src_type=web&web_src=' + location.protocol + '://' + dm;
                }

                function launch(schema, fail){
                    var start = +new Date();

                    location.href = schema;
                    
                    setTimeout(function(){
                        var gap = +new Date() - start;

                        // gap above 1000ms seen as manual return
                        if(gap < 6000){//1000
                            fail && fail();
                        }
                    }, 5000);//800
                }

                function fallback(){
                    // automaticlly return when no mobile QQ installed

                    // window.open is not allowed in some android browser
                    // window.open('https://wpd.b.qq.com/page/info.php?nameAccount=' + nameAccount, '_blank');

                    location.href = 'https://wpd.b.qq.com/page/info.php?nameAccount=' + nameAccount;
                }
            });
        },

        // Launch PC QQ chat
        launchAIOChat: function(){
            var iframe = document.createElement('iframe'),
                body = document.getElementsByTagName('body')[0];
            iframe.style.display = 'none';
            body.insertBefore(iframe, body.firstChild);

            return function(callback){
                var params = this.params,
                    kfuin = this.kfuin,
                    opts = {
                        na: params.nameAccount,
                        kfuin: kfuin,
                        aty: params.aty,
                        a: params.a,
                        sid: this.sid,
                        uid: ta.uid,
                        url: domain.url,
                        title: document.title,
                        dm: domain.topDomain,
                        clkSrc: params.clkSrc || '',
                        ext: params.ext || ''
                    },
                    guid = GUID();

                var sptReport = speedReport('7818', '21', '2');

                getJSONP('https://wpd.b.qq.com/cgi/get_sign.php', opts, function(rs){
                    if(!rs || rs.r !== 0 || !rs.data){
                        return;
                    }

                    iframe.src = rs.data.sign;

                    var isLoaded = false,
                        loaded = function(){
                            // make sure no double run
                            if(isLoaded){
                                return;
                            }

                            isLoaded = true;

                            var clickId = rs.data.clkID;

                            // todo
                            // use event mod to clean up main stream

                            // report log
                            sptReport.addPoint(5).send();
                            report('https://promreport.crm2.qq.com/wpaclick/r.gif?ty=1&kfuin=' + kfuin + '&version=' + globalSettings.version + '&browser=' + encodeURIComponent(navigator.userAgent) + '&bfrom=1&appointType=' + params.aty + '&appoint=' + params.a + '&clkID=' + clickId + '&guid=' + guid);

                            //inform TA
                            global.taClick && global.taClick(clickId, 'clickid');

                            // delay callback because schema causes time
                            // in case of calling back too early, delay callback for a while
                            // todo
                            // is 1000ms too long?
                            typeEnhance.isFunction(callback) && setTimeout(function(){
                                callback(params);
                            }, 1000);
                        };

                    onIframeLoaded(iframe, loaded);

                    // fallback solution
                    // in some cases like security setting higher than low-middle in ie, readyState will remain interactive and never be loaded
                    // for this case, interactive ready state is already good to fire callback, so use setTimeout checking instead of iframe loaded
                    if(browser.msie){
                        var fallback = function(){
                            setTimeout(function(){
                                if(isLoaded){
                                    return;
                                }

                                /interactive/.test(iframe.readyState) ? loaded() : fallback();
                            }, 500);
                        };

                        fallback();
                    }
                });

                report('https://promreport.crm2.qq.com/wpaclickorg/r.gif?kfuin=' + kfuin + '&version=' + globalSettings.version + '&browser=' + encodeURIComponent(navigator.userAgent) + '&bfrom=1&appointType=' + params.aty + '&appoint=' + params.a + '&guid=' + guid);
            }
        }(),

        // Launch anonymous chat
        launchAnonymousChat: function (callback){
            var params = this.params,
                // record load time of anonymous page
                sptReport = speedReport('7818', '21', '2'),
                url = 'https://wpd.b.qq.com/page/webchat.html?nameAccount=' + this.nameAccount,
                opener = window.open(url, '_blank', 'height=516, width=598,toolbar=no,scrollbars=no,menubar=no,status=no,location=no');

            typeEnhance.isFunction(callback) && callback(params);

            // report log
            report('https://promreport.crm2.qq.com/wpaclick/r.gif?ty=2&kfuin=' + this.kfuin + '&version=' + globalSettings.version + '&browser=' + encodeURIComponent(navigator.userAgent) + '&bfrom=1&appointType=' + params.aty + '&appoint=' + params.a);

            opener.onload = function(){
                sptReport.addPoint(6).send();
            };
        }
    };

    return WPA;
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-4 下午3:58
 */
BizQQWPA.define('util.getJSONP', 'util.getScript,util.serialize', function(require){
    var getScript = require('getScript'),
        serialize = require('serialize');

    var count = 0;

    return function(url, options, callback){
        var fnName = 'JSONP_CALLBACK_' + ++count + '_' + Math.round(Math.random() * 100),
            script;

        options.cb = fnName;
        url += url.indexOf('?') === -1 ? '?' : '&';
        url += serialize(options);

        script = getScript(url);

        window[fnName] = function(json){
            callback(json);

            setTimeout(function(){
                // set window.fnName when inside JSONP callback will cause error
                window[fnName] = null;

                // clean up script tag
                script.parentNode.removeChild(script);
            }, 1);
        };
    };
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-28 上午11:27
 */
BizQQWPA.define('wpa.filter', 'util.domain', function(require){
    var TA_BLACKLIST = '',
        CRM_BLACKLIST = 'qq.com,pengyou.com,qzoneapp.com,nipic.com,docin.com,51zxw.net,2155.com,xd.com,yto.net.cn,c-c.com,27.cn,05wan.com,alivv.cn,gogo.com,doctorjob.com.cn,emoney.cn,m4.cn,chinaktv.net,yk988.com,bangkaow.com,wsxsp.com,55tools.com,youxi518.com',
        CRM_WHITELIST = 'b.qq.com,sales.b.qq.com,guilin.house.qq.com,ta.qq.com,hn.qq.com,nantong.house.qq.com';

    var domain = require('domain');

    return {
        TA: function(){
            //in case of ip
            var dm = domain.topDomain,
                IPReg = /^[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d$/,
                LocalReg = /^localhost$/,
                previewPageReg = /^wpa\.b\.qq\.com/;

            return TA_BLACKLIST.indexOf(dm) === -1 && !IPReg.test(dm) && !LocalReg.test(dm) && !previewPageReg.test(domain.domain);
        }(),

        CRM: function(){
            //match white list
            try{
                var reg = new RegExp('(^|,)' + domain.domain);
                if(reg.test(CRM_WHITELIST)){
                    return true;
                }

                //check black list
                var dm = domain.topDomain,
                    dmReg = new RegExp('(^|,)' + dm),
                    IPReg = /^[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d\.[12]?\d?\d$/, //IP check
                    LocalReg = /^localhost$/; //localhost check

                return !dmReg.test(CRM_BLACKLIST) && !IPReg.test(dm) && !LocalReg.test(dm);
            } catch(e){}
        }()
    };
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-27 下午8:01
 */
BizQQWPA.define('wpa.ta', 'util.getScript,util.serialize,util.cookie', function(require){
    var URL = 'https://tajs.qq.com/crmqq.php',
        UID_COOKIE_NAME = 'pgv_pvi';

    var getScript = require('getScript'),
        serialize = require('serialize'),
        cookie = require('cookie');

    var loaded = false;

    var ta = function(nameAccount, domain, callback){
        var isTriggered = false;
        if(ta.uid){
            callback(ta.uid);
            isTriggered = true;
        }

        if(!loaded){
            var options = {
                    uid: nameAccount,
                    dm: domain
                },
                url = URL + '?' + serialize(options, '=', '&');

            getScript(url, function(){
                loaded = true;

                if(isTriggered){
                    return;
                }

                ta.uid = cookie.get(UID_COOKIE_NAME);
                if(ta.uid){
                    callback(ta.uid);
                } else {
                    setTimeout(arguments.callee, 30);
                }
            });
        }
    };

    // A page shares a uid
    // So cache it in model's static variant
    ta.uid = cookie.get(UID_COOKIE_NAME)|| '';

    return ta;
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-27 下午8:32
 */
BizQQWPA.define('wpa.invite', 'util.log,util.getJSONP,util.proxy,util.domain,util.blockStorage,util.taskMgr,wpa.wpaMgr', function(require){
    //task execute gaps
    var MASTER_MONITOR_GAP = 2000, //time gap that slave monitors master
        INVITE_MONITOR_GAP = 1000, //time gap that slave monitors invite state
        MASTER_HEATBEAT_GAP = 2000, //mater's heartbeat gap
        SLAVE_HEARTBEAT_GAP = 2000, //slave's heartbeat gap
        SERVER_MONITOR_GAP_MIN = 5000, //the floor gap that master monitors server
        SERVER_MONITOR_GAP_MAX = 15000, //the ceil gap that master monitors server
        SERVER_MONITOR_SLEEPCHECK_GAP = 3600000, //the gap that before master checking web page's residence time, if bigger than the gap, then stop server monitor and sleep
        SERVER_MONITOR_SLEEPING_GAP = 1000; //the gap master checking web page's activity, if alive again, then recover server monitor

    //kfuin cookie keys
    var INVITE_SIGNAL = 'is', //invite state's signal
        INVITE_KFEXT = 'ik', //invite kfext
        INVITE_MSG = 'msg', //invite msg
        MASTER_HEARTBEATS = 'mh', //master's last heartbeat time(in timestamp)
        MASTER_ID = 'mid', //master's id, for recover and de-emphasis
        SLAVE_IDS = 'slid'; //slave's id, prefix for slave id list and slave heartbeat

    //cookie values
    var INVITE_SIGNAL_UNINVITED = '0', //uninvite state
        INVITE_SIGNAL_INVITE = '1', //inviting state
        INVITE_SIGNAL_INVITED = '2', //invited state
        INVITE_KFEXT_AUTO = '0', //automatic diversion
        MASTER_HEARTBEATS_ERROR = '-1', //master heartbeat's value when error occurs
        DATA_SEPERATOR = '|'; //seperator for data

    //CGIs
    var HEARTBEAT_URL = 'https://visitor.crm2.qq.com/cgi/visitorcgi/ajax/wpa_heart_beat.php', //cgi url for user's heartbeat report and getting invite state
        CONFIRM_AUTO_INVITE_URL = 'https://visitor.crm2.qq.com/cgi/visitorcgi/ajax/auto_invite.php'; //cgi url for confirming raising an auto invite

    //CGI code
    var RESULT_SUCCESS = 0, //success code for all cgi
        INVITE_STATE_UNINVITED = '0', //uninvited state value
        INVITE_STATE_INVITE = '1', //inviting state value
        INVITE_STATE_INVITED = '2', //invited state value
        AUTO_INVITE_TRUE = 1; //value that confirms auto invite

    var WPA_TYPE_TA_INVITE_ONLY = '0', //no wpa will be created, TA & invite logic only
        WPA_TYPE_NORMAL = '1', //normal wpa, with TA & invite logic
        WPA_TYPE_LINK = '2', //for forumn & weibo, a link
        SESSION_VERSION_TA = '4', //session version for wpa with TA, seperated from user customed wpa
        WPA_STYLE_TYPE_INVITE = '20', //invite wpa's style type
        APPOINTED_TYPE_AUTO = '0', //appointed type of automatic diversion
        APPOINTED_TYPE_KFEXT = '1', //appointed type of appointed kfext
        APPOINTED_TYPE_GROUP = '2', //appointed type of appointed group
        APPOINTED_TYPE_AUTO_INVITE = '4', //appointed type of auto invite
        APPOINTED_TYPE_INVITE = '5'; //appointed type of invite


    var WPA_FLOAT_TYPE_FIXED = '0', //wpa style: float style fixed
        WPA_FLOAT_POSITION_Y_CENTER = '1', //wpa style: y-coordinate position, center
        WPA_FLOAT_POSITION_X_CENTER = '1', //wpa style: x-coordinate position, center
        IS_INVITE_WPA_FALSE = '0', //param that seperate wpa conversations, false means normal wpa conversation
        IS_INVITE_WPA_TRUE = '1'; //param that seperate wpa conversations, invite wpa conversation

    var log = require('log'),
        getJSONP = require('getJSONP'),
        proxy = require('proxy'),
        domain = require('domain'),
        blockStorage = require('blockStorage'),
        taskMgr = require('taskMgr'),
        wpaMgr = require('wpaMgr');

    var Slave = function(nameAccount, uid, cfg){
        //Slave initiation
        this.nameAccount = nameAccount;
        this.uid = uid;
        this.config = cfg;
        this.genID();
        this.storage = blockStorage(nameAccount);

        //monitor
        this.monitors = {
            master: taskMgr.newTask(proxy(this, this.masterMonitor), MASTER_MONITOR_GAP).run(),
            invite: taskMgr.newTask(proxy(this, this.inviteMonitor), INVITE_MONITOR_GAP).run()
        };

        //report slave heart beat
        this.heartBeat = taskMgr.newTask(proxy(this, this.heartBeatProcess), SLAVE_HEARTBEAT_GAP).run();

        //set slave active
        this.setActive();

        //bind focus
        window.onfocus = proxy(this, this.setActive);

        log('slave ' + this.id + ' launched!');
    };

    Slave.prototype = {
        genID: function(){
            //pattern: (uin)slid_xxx_xx
            this.id = 'slid_' + +new Date()%1000 + '_' + Math.round(Math.random() * 100);
        },
        masterMonitor: function(){
            if(masters[this.nameAccount]){
                return;
            }
            log('monitoring mater state');
            var lastMasterHeartbeat = this.storage.get(MASTER_HEARTBEATS) || 0,
                gap = +new Date() - parseInt(lastMasterHeartbeat);
            log('gap of master is ' + gap);
            if(gap > 3 * MASTER_HEATBEAT_GAP){
                this.recoverMaster();
            }
        },
        recoverMaster: function(){
            masters[this.nameAccount] = new Master(this.nameAccount, this.uid, this.config);

            log('recover master by slave ' + this.id);
        },
        inviteMonitor: function(){
            if(this.isInvited()){
                this.kill();
            } else if(this.isInviting()){
                if(this.isActive()){
                    this.invite();
                }
            }

            log('slave ' + this.id + ' monitoring invite state');
        },
        kill: function(){
            //stop tasks
            this.monitors.invite.drop();
            this.heartBeat.drop();

            //recycle storage
            var storage = this.storage,
                keys = [this.id];
            for(var i=0, key; key=keys[i++];){
                storage.del(key);
            }

            log('slave ' + this.id + ' killed');
        },
        invite: function(){
            var kfext = this.storage.get(INVITE_KFEXT);
            //create invite view
            var params = {
                wty: WPA_TYPE_NORMAL,
                nameAccount: this.nameAccount,
                kfuin: this.config.kfuin,
                type: WPA_STYLE_TYPE_INVITE,
                aty: kfext ? (kfext === INVITE_KFEXT_AUTO ? APPOINTED_TYPE_AUTO_INVITE : APPOINTED_TYPE_INVITE) : APPOINTED_TYPE_AUTO_INVITE,
                a: kfext || '',
                iv: IS_INVITE_WPA_TRUE,
                fsty: WPA_FLOAT_TYPE_FIXED,
                fposX: WPA_FLOAT_POSITION_X_CENTER,
                fposY: WPA_FLOAT_POSITION_Y_CENTER,
                sv: SESSION_VERSION_TA,
                uid: this.uid,
                dm: domain.topDomain,
                msg: this.storage.get(INVITE_MSG)
            };

            wpaMgr.invite(params, this.config.di);

            this.storage.set(INVITE_SIGNAL, INVITE_SIGNAL_INVITED);

            log('invited by slave ' + this.id);
        },
        heartBeatProcess: function(){
            var storage = this.storage,
                ids = storage.get(SLAVE_IDS);

            if(!ids){
                storage.set(SLAVE_IDS, this.id + '|');
            } else if( ids.indexOf(this.id + '|') === -1){
                storage.set(SLAVE_IDS, this.id + '|' + ids);
            }

            storage.set(this.id, +new Date());
        },
        setActive: function(){
            var storage = this.storage,
                ids = storage.get(SLAVE_IDS) || '',
                sign = this.id + DATA_SEPERATOR;

            if(ids.indexOf(this.id) > -1){
                ids = ids.replace(sign, '');
            }
            ids += sign;

            storage.set(SLAVE_IDS, ids);
        },
        isActive: function(){
            var slaves = this.storage.get(SLAVE_IDS);
            if(!slaves){
                return false;
            }
            return slaves.substr(0, slaves.length-1).split(DATA_SEPERATOR).pop() === this.id;
        },
        isInvited: function(){
            return this.storage.get(INVITE_SIGNAL) === INVITE_SIGNAL_INVITED;
        },
        isInviting: function(){
            return this.storage.get(INVITE_SIGNAL) === INVITE_SIGNAL_INVITE;
        }
    };

    var masters = {};

    var Master = function(nameAccount, uid, cfg){
        //Master initiation
        this.nameAccount = nameAccount;
        this.uid = uid;
        this.config = cfg;
        this.storage = blockStorage(nameAccount);
        this.genID();
        this.sleep = false;
        this.heartBeatURl = cfg.hbDomain || HEARTBEAT_URL;

        //report master heart beat
        this.storage.set(MASTER_ID, this.id);
        this.heartBeatProcess();
        this.heartBeat = taskMgr.newTask(proxy(this, this.heartBeatProcess), MASTER_HEATBEAT_GAP).run();

        //get config & start monitor
        this.initWithConfig();

        log('master launched!');
    };

    Master.prototype = {
        genID: function(){
            this.id = +new Date()%1000 + '_' + Math.round(Math.random() * 100);
        },
        setInviteState: function(signal, kfext, msg){
            if(signal === INVITE_SIGNAL_INVITE){
                this.storage.set(INVITE_KFEXT, kfext);
                this.storage.set(INVITE_MSG, msg);
            }

            this.storage.set(INVITE_SIGNAL, signal);
        },
        isInvited: function(){
            var invited = this.storage.get(INVITE_SIGNAL) === INVITE_SIGNAL_INVITED;
            if(invited){
                this.recycle();
                this.isInvited = function(){
                    return true;
                }
            }
            return invited;
        },
        initWithConfig: function(){
            /*
             r	错误码，0-成功，其他-失败
             isAuto	是否开启自动邀请的开关，0-关、1-开
             autoTime	自动邀请的时间，超过该时间且开关开的情况下，发起邀请
             gap	下次心跳的时间间隔，如果为空使用默认时间
             inviteState	是否有主动邀请， 0-未邀请、1-发起邀请、2-已邀请
             */
            var cfg = this.config;

            //fail getting config data
            if(cfg.r !== RESULT_SUCCESS){ //shouldn't retry, in case of avalanche effect
                this.storage.set(MASTER_HEARTBEATS, MASTER_HEARTBEATS_ERROR);
                return;
            }

            //set auto invite
            if(cfg.isAuto === AUTO_INVITE_TRUE){
                this.storage.set(INVITE_MSG, cfg.autoMsg);
                this.autoInviteTimer = setTimeout(proxy(this, function(){
                    this.autoInvite();
                }), cfg.autoTime * 1000);
            }

            //launch server & slave monitors
            this.monitors = {
                slave: taskMgr.newTask(proxy(this, this.slaveMonitor), SLAVE_HEARTBEAT_GAP).run(),
                server: taskMgr.newTask(proxy(this, this.serverMonitor), SERVER_MONITOR_GAP_MIN).run(),
                sleep: taskMgr.newTask(proxy(this, this.sleepMonitor), SERVER_MONITOR_SLEEPCHECK_GAP).run()
            };

            log('master inited with config');
        },
        autoInvite: function(){
            //confirm auto invite
            //local confirm
            if(this.isInvited()){
                return;
            }

            //remote confirm
            var opt = {
                    nameAccount: this.nameAccount,
                    //kfext: this.kfext,
                    uid: this.uid
                };

            // pause heartbeat in case of overwriting invite state while auto-inviting
            // if heartbeat before a slave get invite state, it will miss the auto-invite
            var serverMonitor = this.monitors.server;
            serverMonitor.pause();

            getJSONP(CONFIRM_AUTO_INVITE_URL, opt, proxy(this, function(rs){
                if(rs.r !== RESULT_SUCCESS){
                    // auto-invite ends, recover heartbeat
                    serverMonitor.run();
                    return;
                }

                if(!this.isInvited()){
                    this.setInviteState(INVITE_SIGNAL_INVITE, INVITE_KFEXT_AUTO, this.storage.get(INVITE_MSG));

                    // delay 5s to recover heartbeat, make sure auto-invite ends
                    taskMgr.once(function(){
                        serverMonitor.run();
                    }, 5000).run();
                }
            }));
        },
        ajustServerMonitorGap: function(time){
            this.monitors.server.setGap(Math.min(Math.max(SERVER_MONITOR_GAP_MIN, time), SERVER_MONITOR_GAP_MAX));
        },
        serverMonitor: function(){
            var inviteSignal = this.storage.get(INVITE_SIGNAL);
            if(this.sleep){
                return;
            }

            var opt = {
                nameAccount: this.nameAccount,
                //kfext: this.kfext,
                uid: this.uid
            };

            //if inviting or invited, tell server to do less
            if(inviteSignal === INVITE_SIGNAL_INVITE){
                opt['inviteState'] = INVITE_STATE_INVITE;
            }

            if(inviteSignal === INVITE_SIGNAL_INVITED){
                opt['inviteState'] = INVITE_STATE_INVITED;
            }

            getJSONP(this.heartBeatURl, opt, proxy(this, function(rs){
                if(rs.r !== RESULT_SUCCESS){
                    return;
                }

                //automatictly ajust server monitor gap
                if(rs.gap){
                    this.ajustServerMonitorGap(rs.gap * 1000);
                }

                if(rs.inviteState === INVITE_STATE_UNINVITED){
                    return;
                }

                if(rs.inviteState === INVITE_STATE_INVITE){
                    this.setInviteState(INVITE_SIGNAL_INVITE, rs.kfext, rs.inviteMsg);
                    return;
                }

                if(rs.inviteState === INVITE_STATE_INVITED){
                    this.setInviteState(INVITE_SIGNAL_INVITED);
                }
            }));
        },
        slaveMonitor: function(){
            if(this.isInvited()){
                this.monitors.slave.drop();
            }

            var storage = this.storage,
                slaves = storage.get(SLAVE_IDS);
            if(!slaves) {
                return;
            }

            slaves = slaves.split(DATA_SEPERATOR);
            var aliveSlaves = '',
                time = +new Date(),
                lastSlaveHeartbeat, slave, gap;
            //check all slaves' state
            for(var i=0; slave=slaves[i++];){
                log('monitoring slave ' + slave + ' state');
                lastSlaveHeartbeat = storage.get(slave) || 0;
                gap = time - parseInt(lastSlaveHeartbeat);
                log('gap of slave ' + slave + ' is ' + gap);
                if(gap > 3 * SLAVE_HEARTBEAT_GAP){
                    //remove dead slave
                    storage.del(slave);
                    log('clear slave ' + slave + ' in storage');
                } else {
                    aliveSlaves += slave + DATA_SEPERATOR;
                }
            }

            storage.set(SLAVE_IDS, aliveSlaves);
        },
        sleepMonitor: function(){
            var slaves = this.storage.get(SLAVE_IDS) || '',
                activeSlave = slaves.substr(0, slaves.length-1).split(DATA_SEPERATOR).pop();
            if(this.sleep){
                //when sleeping
                //if new slave appears, wake up
                if(this.activeSlave !== activeSlave){
                    this.activeSlave = activeSlave;
                    this.sleep = false;
                    this.monitors.sleep.setGap(SERVER_MONITOR_SLEEPCHECK_GAP);
                }
            } else {
                //when sleeping
                //if no new slave appear, sleep
                if(this.activeSlave === activeSlave){
                    this.sleep = true;
                    this.monitors.sleep.setGap(SERVER_MONITOR_SLEEPING_GAP);
                } else {
                    this.activeSlave = activeSlave;
                }
            }
        },
        kill: function(){
            masters[this.nameAccount] = undefined;

            //stop tasks
            if( this.monitors ){
                this.monitors.server.drop();
                this.monitors.slave.drop();
                this.heartBeat.drop();
                clearTimeout(this.autoInviteTimer);
            }

            log('master killed');
        },
        recycle: function(){
            //recycle storage
            var storage = this.storage,
                keys = [INVITE_KFEXT, INVITE_MSG];
            for(var i=0, key; key=keys[i++];){
                storage.del(key);
            }

            log('storage recycled');
        },
        heartBeatProcess: function(){
            var storage = this.storage;

            if(storage.get(MASTER_ID) !== this.id){
                this.kill();
                return false;
            }
            this.storage.set(MASTER_HEARTBEATS, +new Date());
        }
    };

    // factory
    var slaves = {};

    return {
        load: function(nameAccount, uid, cfg){
            if(this.isLoaded(nameAccount)){
                log(nameAccount + ' slave already running');
                return;
            }

            var slave = new Slave(nameAccount, uid, cfg);
            slaves[nameAccount] ? slaves[nameAccount].push(slave) : slaves[nameAccount] = [slave];
        },

        isLoaded: function(nameAccount){
            return typeof slaves[nameAccount] !== 'undefined';
        }
    };
});/**
 * @fileOverview
 * @author amoschen
 * @version
 * Created: 12-8-4 下午1:20
 */
BizQQWPA.define('util.taskMgr', 'util.proxy', function(require){
    /**
     * @Class TaskManager
     * Manage scheduled tasks, with one timer and performance optimization
     */

    //requestAnimationFrame will stop functioning when page is out of vision
    /**
     * requestAnimationFrame
     */
    /*
     var timer = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
     window.webkitRequestAnimationFrame || window.msRequestAnimationFrame || function (fn) { setTimeout(fn, 13);};
     */

    var TASK_RUN = 'run', //task state: running
        TASK_PAUSE = 'pause', //task state: pauseed
        TASK_DROP = 'drop', //task state: to be dropped
        LOOP_TIME = 50; //execution time in a loop

    var proxy = require('proxy');

    var TM = function(){
        this.circle = [];
        this.pos = 0;
        setInterval(proxy(this, this.loop), 16);
    };

    TM.prototype = {
        //factory mode, create task an instance
        newTask: function(fn, gap){
            var t = new Task(fn, gap);
            this.circle.push(t);
            return t;
        },

        //create once job
        once: function(fn, gap){
            return this.newTask(function(){
                fn.apply(this);
                this.drop();
            }, gap);
        },

        //main loop, execute tasks in sequence and stop when loop time is up
        loop: function(){
            var c = this.circle,
                pos = this.pos,
                count = c.length,
                start = +new Date(),
                loopTime = LOOP_TIME,
                t = c[pos];

            while(count > 0 && +new Date() - start < loopTime){
                if(t.isRunning()){
                    t.execute();
                } else if(t.isDropped()){
                    c.splice(pos, 1);
                    pos--;
                }

                pos = (pos + 1) % c.length;
                t = c[pos];
                count--;
            }

            this.pos = pos;
        }
    };

    /*
     * @Class Task
     * a task is a function to be executed every certain time
     */
    var Task = function(fn, gap){
        this.fn = fn;
        this.gap = gap;
        this.status = TASK_PAUSE;
        this.lastExecTime = +new Date();
    };

    Task.prototype = {
        run: function(){
            this.status = TASK_RUN;
            return this;
        },

        pause: function(){
            this.status = TASK_PAUSE;
            return this;
        },

        drop: function(){
            this.status = TASK_DROP;
            return this;
        },

        execute: function(){
            if(+new Date() - this.lastExecTime < this.gap){
                return false;
            }

            this.fn();
            this.lastExecTime = +new Date();
            return true;
        },

        getGap: function(){
            return this.gap;
        },

        setGap: function(newGap){
            this.gap = newGap;
            return this;
        },

        isRunning: function(){
            return this.status === TASK_RUN;
        },

        isPaused: function(){
            return this.status === TASK_PAUSE;
        },

        isDropped: function(){
            return this.status === TASK_DROP;
        }
    };

    return new TM();
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-7
 * Time: 上午11:47
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('lang.browser', function(){
    var ua = navigator.userAgent.toLowerCase();

    var browser = {};

    // Browser Base
    // Borrowed from jQuery
    var match = /(chrome)[ \/]([\w.]+)/.exec( ua ) ||
        /(webkit)[ \/]([\w.]+)/.exec( ua ) ||
        /(opera)(?:.*version|)[ \/]([\w.]+)/.exec( ua ) ||
        /(msie) ([\w.]+)/.exec( ua ) ||
        ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec( ua ) ||
        [];

    // ie11 support
    // ie11 ua change: https://msdn.microsoft.com/zh-cn/library/ie/hh869301(v=vs.85).aspx
    var matchIe11;
    if(ua.indexOf('trident') > -1 && ( matchIe11 = /rv:([\d.]+)/.exec( ua ) )){
        match[1] = 'msie';
        match[2] = matchIe11[1];
    }

    var matched = {
        browser: match[ 1 ] || "",
        version: match[ 2 ] || "0"
    };

    if ( matched.browser ) {
        browser[ matched.browser ] = true;
        browser.version = matched.version;
    }

    // Chrome is Webkit, but Webkit is also Safari.
    if ( browser.chrome ) {
        browser.webkit = true;
    } else if ( browser.webkit ) {
        browser.safari = true;
    }

    // Mobile detect
    var isMobile = browser.isMobile = ua.match(/(nokia|iphone|android|motorola|^mot\-|softbank|foma|docomo|kddi|up\.browser|up\.link|htc|dopod|blazer|netfront|helio|hosin|huawei|novarra|CoolPad|webos|techfaith|palmsource|blackberry|alcatel|amoi|ktouch|nexian|samsung|^sam\-|s[cg]h|^lge|ericsson|philips|sagem|wellcom|bunjalloo|maui|symbian|smartphone|midp|wap|phone|windows ce|iemobile|^spice|^bird|^zte\-|longcos|pantech|gionee|^sie\-|portalmmm|jig\s browser|hiptop|^ucweb|^benq|haier|^lct|opera\s*mobi|opera\*mini|320x320|240x320|176x220)/i);

    browser.isWindow = /windows|win32/.test(ua);

    browser.isMac = /Mac/.test(ua);

    browser.isIOS = /(?:iphone|ipad|ipod)/i.test(ua);

    browser.isAndroid = /android/i.test(ua);

    if(isMobile){
        var QQReg = /QQ\/(\d+\.\d+)\.\d/,
            OldQQReg = /V1_AND_SQ_(\d+\.\d+)\.\d/,
            match = QQReg.exec(ua) || OldQQReg.exec(ua);

        browser.isQQ = !match;
        match && (browser.QQVersion = match[1]);
    }


    return browser;
});
/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-7
 * Time: 下午3:16
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('util.pad', function(){
    return function(str, pad, length, isLeft){
        var padLength = length - str.length,
            i;

        if(isLeft === false){
            for(i=0; i<padLength; i++){
                str += pad;
            }
        } else {
            for(i=0; i<padLength; i++){
                str = pad + str;
            }
        }

        return str;
    };
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-7
 * Time: 下午2:44
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('util.Bits', 'util.proxy,util.pad', function(require){
    var proxy = require('proxy'),
        pad = require('pad');

    return function(){
        var setChar = function(str, index, newChar){
            return str.replace(new RegExp('(^[\\d]{' + index + '})\\d'), '$1#' + newChar).replace('#', '');
        };

        var Bits = function(bits){
            this.bits = bits;
        };

        Bits.prototype = {
            pad: function(){
                var args = Array.prototype.slice.call(arguments);
                this.bits = pad.apply(this, [this.bits].concat(args));
                return this;
            },

            padLeft: function(){
                return proxy(this, this.pad);
            },

            padRight: function(){
                var args = Array.prototype.slice.call(arguments).push(false);
                return this.pad.apply(this, args);
            },

            getChar: function(index){
                return this.bits.charAt(index);
            },

            setChar: function(index, value){
                this.bits = setChar(this.bits, index, value);
                return this;
            },

            reverse: function(){
                var bits = this.bits,
                    length = bits.length;

                for(var i=0; i<length; i++){
                    this.setChar(i, parseInt(bits[i], 2) ^ 1);
                }

                return this;
            }
        };

        return Bits;
    }();
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-7
 * Time: 下午3:42
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('util.events', function(){
    var events = {};

    /**
     * Bind event to node
     * @public
     * @param {HTMLElement} node The node to be bound
     * @param {string} type The event type
     * @param {function} event Event's handler
     * @return {HTMLElement} The node itself
     */
    events.addEvent = window.addEventListener ? function(node, type, event){
            node.addEventListener(type, event);
            return node;
        } : function(node, type, event){
            node.attachEvent('on' + type, event);
            return node;
        };

    /**
     * Unbind event from node
     * @param {HTMLElement} node The node to be unbound
     * @param {string} type The event type
     * @param {function} event Event's handler
     * @return {HTMLElement} The node itself
     */
    events.removeEvent = window.removeEventListener ? function(node, type, event){
            node.removeEventListener(type, event);
            return node;
        } : function(node, type, event){
            node.detachEvent('on' + type, event);
            return node;
        };

    return events;
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-7
 * Time: 下午3:27
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('util.onLoad', 'util.events', function(require){
    var events = require('events');
    /**
     * Add event handler to onLoad event
     * @param {function} fn Event handler
     * @param {object} [context=window] The context to add event listener
     */
    return onLoad = function(fn, context){
            context = context || window;

            if(/loaded|complete|undefined/.test(context.document.readyState)){
                fn();
            } else {
                events.addEvent(context, 'load', fn);
            }

            return context;
        };
});/**
 * Created with JetBrains WebStorm.
 * User: amoschen
 * Date: 13-1-7
 * Time: 下午4:24
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('util.offset', function(){
    var doc = document,
        isStandardMode = doc.compatMode == "CSS1Compat",
        docElem = doc.documentElement,
        body = doc.body;

    return {
        /**
         * 获取对象getScrollTop值
         */
        getScrollTop: function(){
            return Math.max(docElem.scrollTop, body.scrollTop);
        },

        /**
         * 获取对象的可视区域高度
         */
        getClientWidth: function(){
            return isStandardMode ? docElem.clientWidth : body.clientWidth;
        },

        /**
         * 获取对象的可视区域高度
         */
        getClientHeight: function(){
            return isStandardMode ? docElem.clientHeight : body.clientHeight;
        }
    }
});/**
 * @Class Panel Panel Component
 * User: amoschen
 * Date: 13-1-7
 * Time: 下午6:17
 * To change this template use File | Settings | File Templates.
 */
BizQQWPA.define('util.Panel', 'lang.browser,util.Style,util.className,util.events,util.offset,util.css,util.proxy', function(require){
    var Style = require('Style'),
        className = require('className'),
        events = require('events'),
        offset = require('offset'),
        browser = require('browser'),
        css = require('css'),
        proxy = require('proxy');

    /**
     * Default settings
     * @type {Object}
     */
    var SETTINGS = {
        // container where panel to be contained
        container: document.getElementsByTagName('body')[0],

        // template of panel
        template: [
            '<div class="WPA3-CONFIRM">',
                '<h3 class="WPA3-CONFIRM-TITLE"><%=title%></h3>',
                '<div class="WPA3-CONFIRM-CONTENT"><%=content%></div>',
                '<div class="WPA3-CONFIRM-PANEL"><%=buttons%></div>',
                '<div class="WPA3-CONFIRM-CLOSE"></div>',
            '</div>'
        ].join(''),

        // template of button
        buttonTemplate: [
            '<a href="javascript:;" class="WPA3-CONFIRM-BUTTON"><span class="WPA3-CONFIRM-BUTTON-PADDING WPA3-CONFIRM-BUTTON-LEFT"></span><span class="WPA3-CONFIRM-BUTTON-TEXT"><%=text%></span><span class="WPA3-CONFIRM-BUTTON-PADDING WPA3-CONFIRM-BUTTON-RIGHT"></span></a>'
        ].join(''),

        // panel's style
        cssText: [
            '.WPA3-CONFIRM { z-index:2147483647; width:285px; height:141px; margin:0; background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAR0AAACNCAMAAAC9pV6+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjU5QUIyQzVCNUIwQTExRTJCM0FFRDNCMTc1RTI3Nzg4IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjU5QUIyQzVDNUIwQTExRTJCM0FFRDNCMTc1RTI3Nzg4Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NTlBQjJDNTk1QjBBMTFFMkIzQUVEM0IxNzVFMjc3ODgiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NTlBQjJDNUE1QjBBMTFFMkIzQUVEM0IxNzVFMjc3ODgiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6QoyAtAAADAFBMVEW5xdCkvtNjJhzf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) no-repeat;}',
            //ie6 7 base64 hack
            '.WPA3-CONFIRM { *background-image:url(https://combo.b.qq.com/crm/wpa/release/3.3/wpa/views/panel.png);}',
            // css reset
            '.WPA3-CONFIRM * { position:static; z-index:auto; top:auto; left:auto; right:auto; bottom:auto; width:auto; height:auto; max-height:auto; max-width:auto; min-height:0; min-width:0; margin:0; padding:0; border:0; clear:none; clip:auto; background:transparent; color:#333; cursor:auto; direction:ltr; filter:; float:none; font:normal normal normal 12px "Helvetica Neue", Arial, sans-serif; line-height:16px; letter-spacing:normal; list-style:none; marks:none; overflow:visible; page:auto; quotes:none; -o-set-link-source:none; size:auto; text-align:left; text-decoration:none; text-indent:0; text-overflow:clip; text-shadow:none; text-transform:none; vertical-align:baseline; visibility:visible; white-space:normal; word-spacing:normal; word-wrap:normal; -webkit-box-shadow:none; -moz-box-shadow:none; -ms-box-shadow:none; -o-box-shadow:none; box-shadow:none; -webkit-border-radius:0; -moz-border-radius:0; -ms-border-radius:0; -o-border-radius:0; border-radius:0; -webkit-opacity:1; -moz-opacity:1; -ms-opacity:1; -o-opacity:1; opacity:1; -webkit-outline:0; -moz-outline:0; -ms-outline:0; -o-outline:0; outline:0; -webkit-text-size-adjust:none;}',
            '.WPA3-CONFIRM * { font-family:Microsoft YaHei,Simsun;}',
            '.WPA3-CONFIRM .WPA3-CONFIRM-TITLE { height:40px; margin:0; padding:0; line-height:40px; color:#2b6089; font-weight:normal; font-size:14px; text-indent:80px;}',
            '.WPA3-CONFIRM .WPA3-CONFIRM-CONTENT { height:55px; margin:0; line-height:55px; color:#353535; font-size:14px; text-indent:29px;}',
            '.WPA3-CONFIRM .WPA3-CONFIRM-PANEL { height:30px; margin:0; padding-right:16px; text-align:right;}',
            '.WPA3-CONFIRM .WPA3-CONFIRM-BUTTON { position:relative; display:inline-block!important; display:inline; zoom:1; width:99px; height:30px; margin-left:10px; line-height:30px; color:#000; text-decoration:none; font-size:12px; text-align:center;}',
            '.WPA3-CONFIRM .WPA3-CONFIRM-BUTTON-FOCUS { width:78px;}',
            '.WPA3-CONFIRM .WPA3-CONFIRM-BUTTON .WPA3-CONFIRM-BUTTON-TEXT { line-height:30px; text-align:center; cursor:pointer;}',
            '.WPA3-CONFIRM-CLOSE { position:absolute; top:7px; right:7px; width:10px; height:10px; cursor:pointer;}'
        ].join(''),

        // default buttons
        buttons: [
            {
                isFocus: true,
                text: '\u786E\u8BA4', //确认
                events: {
                    click: function(){
                        this.remove();
                    }
                }
            },
            {
                text: '\u53D6\u6D88', //取消
                events: {
                    click: function(){
                        this.remove();
                    }
                }
            }
        ],

        // use modal or not
        modal: true
    };

    // add confirm style to page
    Style.add('_WPA_CONFIRM_STYLE', SETTINGS.cssText);

    /**
     * Panel constructor
     * @constructor
     */
    var Panel = function(opts){
        this.opts = opts;
        this.render();
    };

    Panel.prototype = {
        render: function(){
            var panel = this,
                opts = this.opts,
                body = this.container = opts.container || document.getElementsByTagName('body')[0];

            // template handler
            var frameHTML = opts.template || SETTINGS.template,
                buttonReplaceID = 'WPA_BUTTONS_PLACE' + (+new Date() % 100) + Math.floor(Math.random() * 100);
            frameHTML = frameHTML.replace(/<%=title%>/g, opts.title || '')
                .replace(/<%=content%>/g, opts.content || '')
                .replace(/<%=buttons%>/g, '<div id="' + buttonReplaceID + '"></div>');

            // create dom element
            var frag = document.createElement('div'),
                frame;
            frag.innerHTML = frameHTML;
            this.$el = frame = frag.firstChild;

            events.addEvent(frame.lastChild, 'click', function(){
                panel.remove();
                opts.onClose && opts.onClose();
            });

            // insert into dom
            (function(){
                try{
                    body.appendChild(frame);
                } catch(e){
                    setTimeout(arguments.callee, 1);
                    return;
                }

                // when frame is inserted into dom

                // render modal
                if(opts.modal || SETTINGS.modal){
                    panel.renderModal();
                }

                // render buttons
                // can't get node when it's still in memory
                panel.renderButtons(buttonReplaceID);

                // set position
                // only node is in document can we get computedStyles correctly
                panel.setCenter();
            })();
        },

        renderButtons: function(buttonReplaceID){
            var replaceElement = document.getElementById(buttonReplaceID),
                parentNode = replaceElement.parentNode;
            parentNode.removeChild(replaceElement);

            var buttonOpts = this.opts.buttons || SETTINGS.buttons,
                buttonTempl = this.opts.buttonTemplate || SETTINGS.buttonTemplate,
                frag = document.createElement('div'),
                button, opt, evts;

            for(var i= 0, l=buttonOpts.length; i<l; i++){
                opt = buttonOpts[i];
                frag.innerHTML = buttonTempl.replace('<%=text%>', opt.text);
                button = frag.firstChild;

                opt.isFocus && className.addClass(button, 'WPA3-CONFIRM-BUTTON-FOCUS');

                // bind events
                if(opt.events){
                    evts = opt.events;
                    for(var type in evts){
                        if(evts.hasOwnProperty(type)){
                            events.addEvent(button, type, proxy(this, evts[type]));
                        }
                    }
                }

                // insert
                parentNode.appendChild(button);
            }
        },

        renderModal: function(){
            var container = this.container,
                width = css(container, 'width'),
                height = css(container, 'height'),
                overflow = css(container, 'overflow');

            var modalLayer = document.createElement('div'),
                styles = {
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    zIndex: 2147483647,
                    width: offset.getClientWidth() + 'px',
                    height: offset.getClientHeight() + 'px',
                    backgroundColor: 'black',
                    opacity: 0.3,
                    filter: 'alpha(opacity=30)'
                };

            // ie6 or quirk mode css reset
            var isQuirk = document.compatMode === 'BackCompat';
            if( (browser.msie && parseInt(browser.version, 10) < 7) || isQuirk){
                // css reset
                styles.position = 'absolute';

                // scroll update
                setInterval(proxy(modalLayer, function(){
                    this.style.top = offset.getScrollTop() + 'px';
                }), 128);
            }

            css(modalLayer, styles);
            container.insertBefore(modalLayer, this.$el);
            this.modal = modalLayer;

            events.addEvent(window, 'resize', proxy(modalLayer, function(){
                css(this, {
                    width: offset.getClientWidth() + 'px',
                    height: offset.getClientHeight() + 'px'
                });
            }));
        },

        show: function(){
            this.css('display', 'block');
            this.modal && css(this.modal, 'display', 'block');
            return this;
        },

        hide: function(){
            this.css('display', 'none');
            this.modal && css(this.modal, 'display', 'none');
            return this;
        },

        remove: function(){
            this.$el.parentNode.removeChild(this.$el);
            this.modal && this.modal.parentNode.removeChild(this.modal);
            return this;
        },

        css: function(){
            var args = [this.$el].concat(Array.prototype.slice.call(arguments));
            return css.apply(this, args);
        },

        setCenter: function(){
            // set position to make sure it would not be affected by parent node
            this.css({
                position: 'absolute', // make it compatible for ie
                top: '50%',
                left: '50%'
            });

            // standard mode css reset
            var styles = {
                position: 'fixed', // reset to fixed in standard mode
                marginLeft: '-' + this.outerWidth()/2 + 'px',
                marginTop: '-' + this.outerHeight()/2 + 'px'
            };

            // ie6 or quirk mode css reset
            var isQuirk = document.compatMode === 'BackCompat';
            if( (browser.msie && parseInt(browser.version, 10) < 7) || isQuirk){
                // css reset
                styles.position = 'absolute';
                styles.marginTop = 0;
                var top = styles.top = (offset.getClientHeight() - this.outerHeight())/2;

                // scroll update
                setInterval(proxy(this.$el, function(){
                    this.style.top = offset.getScrollTop() + top + 'px';
                }), 128);
            }

            // batch set styles
            this.css(styles);
        },

        outerWidth: function(){
            return this.$el.offsetWidth;
        },

        outerHeight: function(){
            return this.$el.offsetHeight;
        }
    };

    return Panel;
});